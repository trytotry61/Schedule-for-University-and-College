<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f4f4f4;
    }

    h1,
    h2 {
      color: #333;
    }

    section {
      background: white;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    input,
    select,
    button {
      padding: 8px;
      margin: 5px;
      font-size: 16px;
    }

    button {
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    button:hover {
      background: #0056b3;
    }

    button.delete {
      background: #dc3545;
    }

    button.delete:hover {
      background: #c82333;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th,
    td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }

    th {
      background: #f8f9fa;
    }

    @media (max-width: 768px) {
      body {
        margin: 10px;
      }

      section {
        padding: 15px;
      }

      table {
        font-size: 13px;
        overflow-x: auto;
        display: block;
      }

      input,
      select,
      button {
        width: 30%;
        box-sizing: border-box;
        margin: 8px 0;
      }

      #lessonsTable {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
      }

      .day-grid {
        border: 1px solid #ccc;
        padding: 10px;
      }

      .lesson-block {
        border: 1px solid #666;
        margin-bottom: 8px;
        padding: 6px;
        background: #f8f8f8;
      }

      .lesson-block input,
      .lesson-block select {
        margin-right: 6px;
      }
    }

    .time-grid {
      display: flex;
      height: 720px;
      /* 12 —á–∞—Å–æ–≤ √ó 60px */
      border: 1px solid #ddd;
      position: relative;
    }

    .time-column {
      width: 70px;
      border-right: 1px solid #ddd;
      font-size: 12px;
      color: #666;
    }

    .time-slot {
      position: absolute;
      left: 0;
      right: 0;
      height: 60px;
      border-top: 1px solid #eee;
      font-size: 12px;
      padding-left: 5px;
      color: #666;
    }

    .lesson-block {
      position: absolute;
      background: #e8f0fe;
      border-left: 4px solid #4285f4;
      border-radius: 6px;
      font-size: 12px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .lesson-time {
      font-size: 11px;
      color: #555;
      margin-bottom: 2px;
    }

    .lesson-subject {
      font-weight: bold;
      margin-bottom: 4px;
    }

    .lesson-meta {
      font-size: 11px;
      color: #333;
    }

    .lesson-remove {
      position: absolute;
      top: 4px;
      right: 4px;
      border: none;
      background: transparent;
      cursor: pointer;
    }

    .lesson-column {
      flex: 1;
      position: relative;
      background: repeating-linear-gradient(to bottom,
          #fafafa 0,
          #fafafa 29px,
          #eee 30px);
    }
  </style>
</head>

<body>
  <h1>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è</h1>
  <button onclick="logout()" style="position: absolute; top: 20px; right: 10px;width: 100px;">–í—ã–π—Ç–∏</button>

  <section id="groupsSection">
    <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥—Ä—É–ø–ø–∞–º–∏</h2>
    <input type="text" id="newGroupName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã, –Ω–∞–ø—Ä–∏–º–µ—Ä –ò–°-21">
    <button onclick="createGroup()">–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</button>

    <h3>–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –≥—Ä—É–ø–ø—ã</h3>
    <ul id="groupsList"></ul>
  </section>
  <section id="bulkOperations">
    <h2>–ú–∞—Å—Å–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</h2>

    <section id="historySection">
      <h2>–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π</h2>
      <button onclick="loadChangeHistory()">–û–±–Ω–æ–≤–∏—Ç—å</button>
      <table id="historyTable">
        <thead>
          <tr>
            <th>–í—Ä–µ–º—è</th>
            <th>–ê–¥–º–∏–Ω</th>
            <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
            <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
    <div>
      <h3>–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –Ω–µ–¥–µ–ª—é</h3>
      <select id="copyGroup"></select>
      <select id="fromWeek">
        <option value="0">–ö–∞–∂–¥—É—é –Ω–µ–¥–µ–ª—é</option>
        <option value="1">–ß—ë—Ç–Ω—É—é</option>
        <option value="2">–ù–µ—á—ë—Ç–Ω—É—é</option>
      </select>
      ‚Üí
      <select id="toWeek">
        <option value="0">–ö–∞–∂–¥—É—é –Ω–µ–¥–µ–ª—é</option>
        <option value="1">–ß—ë—Ç–Ω—É—é</option>
        <option value="2">–ù–µ—á—ë—Ç–Ω—É—é</option>
      </select>
      <button onclick="copyWeek()">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
    </div>
    <div style="margin-top: 20px;">
      <h3>–û—á–∏—Å—Ç–∏—Ç—å –Ω–µ–¥–µ–ª—é</h3>
      <select id="clearGroup"></select>
      <select id="clearWeek">
        <option value="0">–ö–∞–∂–¥—É—é –Ω–µ–¥–µ–ª—é</option>
        <option value="1">–ß—ë—Ç–Ω—É—é</option>
        <option value="2">–ù–µ—á—ë—Ç–Ω—É—é</option>
      </select>
      <button class="delete" onclick="clearWeek()">–û—á–∏—Å—Ç–∏—Ç—å</button>
    </div>
    <div style="margin-top: 20px;">
      <h3>–ó–∞–º–µ–Ω–∏—Ç—å –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è</h3>
      <select id="replaceGroup"></select>
      <input type="text" id="oldTeacher" placeholder="–°—Ç–∞—Ä—ã–π –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å">
      <input type="text" id="newTeacher" placeholder="–ù–æ–≤—ã–π –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å">
      <button onclick="replaceTeacher()">–ó–∞–º–µ–Ω–∏—Ç—å</button>
    </div>
  </section>

  <section id="lessonsSection">
    <h2>–î–æ–±–∞–≤–∏—Ç—å –∑–∞–Ω—è—Ç–∏–µ</h2>
    <select id="scheduleGroup"></select>
    <label>–í—Ä–µ–º—è</label>
    <input type="time" id="startTime">
    <input type="time" id="endTime">
    <input type="text" id="subject" placeholder="–ü—Ä–µ–¥–º–µ—Ç">
    <select id="lessonTeacher">
      <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è</option>
    </select>
    <input type="text" id="room" placeholder="–ê—É–¥–∏—Ç–æ—Ä–∏—è">
    <select id="lessonType">
      <option value="lecture">–õ–µ–∫—Ü–∏—è</option>
      <option value="practice">–ü—Ä–∞–∫—Ç–∏–∫–∞</option>
      <option value="lab">–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è</option>
    </select>
    <button onclick="addLesson()">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–Ω—è—Ç–∏–µ</button>
    <button onclick="saveScheduleByDay()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–µ–Ω—å</button>
  </section>
  <section id="dayEditor">
    <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –ø–æ –¥–∞—Ç–µ</h2>

    <label>
      –î–∞—Ç–∞:
      <input type="date" id="dayEditorDate">
    </label>

    <button onclick="loadScheduleByDay()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–µ–Ω—å</button>
  </section>

  <section id="dayGridSection">
    <h3 id="dayTitle"></h3>
    <div class="time-grid">
      <div class="time-column"></div>
      <div id="dayGrid" class="lesson-column"></div>
    </div>

    <button onclick="saveScheduleByDay()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–µ–Ω—å</button>
  </section>










  <script src="js/api.js"></script>
  <script>
    /**
     * @file admin.html ‚Äî –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π —Å–∫—Ä–∏–ø—Ç
     * @description –õ–æ–≥–∏–∫–∞ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏: —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥—Ä—É–ø–ø–∞–º–∏, –∑–∞–Ω—è—Ç–∏—è–º–∏, –º–∞—Å—Å–æ–≤—ã–º–∏ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏ –∏ –∏—Å—Ç–æ—Ä–∏–µ–π –∏–∑–º–µ–Ω–µ–Ω–∏–π.
     * 
     * –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è —á–µ—Ä–µ–∑ –≥–ª–æ–±–∞–ª—å–Ω—ã–π apiRequest –∏–∑ api.js (—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º refresh —Ç–æ–∫–µ–Ω–∞).
     * 
     * –î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É (–∑–∞—â–∏—â–µ–Ω–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ).
     */


    /** –ú–∞—Å—Å–∏–≤ –¥–Ω–µ–π –Ω–µ–¥–µ–ª–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —Ç–∞–±–ª–∏—Ü–µ –∑–∞–Ω—è—Ç–∏–π */
    const days = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±'];

    /** –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –≥—Ä—É–ø–ø (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –º–∞—Å—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö) */
    let currentGroups = [];
    let currentLessons = [];
    let teachersMap = {};

    /**
     * –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≥—Ä—É–ø–ø —Å —Å–µ—Ä–≤–µ—Ä–∞ –∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
     */
    async function loadGroups() {
      try {
        const groups = await apiRequest('/api/admin/groups');

        const list = document.getElementById('groupsList');
        const select = document.getElementById('scheduleGroup');
        list.innerHTML = '';
        select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É</option>';

        currentGroups = groups;  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è –º–∞—Å—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

        groups.forEach(g => {
          // –≠–ª–µ–º–µ–Ω—Ç —Å–ø–∏—Å–∫–∞ –≥—Ä—É–ø–ø —Å –∫–Ω–æ–ø–∫–æ–π —É–¥–∞–ª–µ–Ω–∏—è
          const li = document.createElement('li');
          li.textContent = g.name;
          const delBtn = document.createElement('button');
          delBtn.textContent = '–£–¥–∞–ª–∏—Ç—å';
          delBtn.className = 'delete';
          delBtn.onclick = () => deleteGroup(g.id);
          li.appendChild(delBtn);
          list.appendChild(li);

          // –û–ø—Ü–∏—è –≤ —Å–µ–ª–µ–∫—Ç–µ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–Ω—è—Ç–∏—è
          const opt = document.createElement('option');
          opt.value = g.id;
          opt.textContent = g.name;
          select.appendChild(opt);
        });

        // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–µ–ª–µ–∫—Ç—ã –≤ —Ä–∞–∑–¥–µ–ª–µ –º–∞—Å—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
        populateBulkSelects();
      } catch (err) {
        alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä—É–ø–ø: ' + err.message);
      }
    }
    //** –î–æ–±–∞–≤–ª—è–µ–º —É—á–∏—Ç–µ–ª–µ–π –≤ —Å–ø–∏—Å–æ–∫
    async function loadTeachers() {
      try {
        const teachers = await apiRequest('/api/admin/teachers');
        const select = document.getElementById('lessonTeacher');

        select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è</option>';
        teachersMap = {}; // ‚Üê üî• –í–ê–ñ–ù–û

        teachers.forEach(t => {
          teachersMap[t.id] = t.full_name;

          const opt = document.createElement('option');
          opt.value = t.id;
          opt.textContent = t.full_name;
          select.appendChild(opt);
        });

        console.log('teachersMap loaded:', teachersMap);
      } catch (err) {
        alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π');
      }
    }



    /**
     * –°–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—É—é –≥—Ä—É–ø–ø—É
     */
    async function createGroup() {
      const name = document.getElementById('newGroupName').value.trim();
      if (!name) return alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ');
      try {
        await apiRequest('/api/admin/groups', {
          method: 'POST',
          body: JSON.stringify({ name })
        });
        document.getElementById('newGroupName').value = '';
        loadGroups();
        loadLessons();
      } catch (err) {
        alert('–û—à–∏–±–∫–∞: ' + err.message);
      }
    }

    /**
     * –£–¥–∞–ª—è–µ—Ç –≥—Ä—É–ø–ø—É –ø–æ ID (—Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º)
     */
    async function deleteGroup(id) {
      if (!confirm('–£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É –∏ –≤—Å–µ –µ—ë –∑–∞–Ω—è—Ç–∏—è? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) return;
      try {
        await apiRequest(`/api/admin/groups/${id}`, { method: 'DELETE' });
        loadGroups();
        loadLessons();
      } catch (err) {
        alert('–û—à–∏–±–∫–∞: ' + err.message);
      }
    }

    /**
     * –î–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤–æ–µ –∑–∞–Ω—è—Ç–∏–µ
     */
    function addLesson() {
      const date = document.getElementById('dayEditorDate').value;
      const groupId = document.getElementById('scheduleGroup').value;

      if (!date || !groupId) {
        alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏ –≥—Ä—É–ø–ø—É');
        return;
      }

      const start_time = document.getElementById('startTime').value;
      const end_time = document.getElementById('endTime').value;
      const subject = document.getElementById('subject').value;
      const room = document.getElementById('room').value;
      const type = document.getElementById('lessonType').value;
      const teacher_id = document.getElementById('lessonTeacher').value || null;

      if (!start_time || !end_time || !subject) {
        alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –∑–∞–Ω—è—Ç–∏—è');
        return;
      }

      currentLessons.push({
        start_time,
        end_time,
        subject,
        room,
        type,
        teacher_id: teacher_id ? Number(teacher_id) : null
      });

      renderTimeGrid();
    }


    /**
     * –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –≤—Å–µ –∑–∞–Ω—è—Ç–∏—è
     */
    async function loadLessons() {
      try {
        const lessons = await apiRequest('/api/admin/lessons');
        const tbody = document.querySelector('#lessonsTable tbody');
        tbody.innerHTML = '';

        lessons.forEach(l => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
          <td>${l.group_name}</td>
          <td>${days[l.day]}</td>
          <td>${l.start_time} - ${l.end_time}</td>
          <td>${l.subject}</td>
          <td>${l.teacher}</td>
          <td>${l.room}</td>
          <td>${l.type}</td>
          <td>${l.week === 0 ? '–∫–∞–∂–¥—É—é' : l.week === 1 ? '—á—ë—Ç–Ω–∞—è' : '–Ω–µ—á—ë—Ç–Ω–∞—è'}</td>
          <td><button class="delete" onclick="deleteLesson(${l.id})">–£–¥–∞–ª–∏—Ç—å</button></td>
        `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–Ω—è—Ç–∏–π: ' + err.message);
      }
    }

    /**
     * –£–¥–∞–ª—è–µ—Ç –∑–∞–Ω—è—Ç–∏–µ –ø–æ ID (—Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º)
     */
    async function deleteLesson(id) {
      if (!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–Ω—è—Ç–∏–µ?')) return;
      try {
        await apiRequest(`/api/admin/lessons/${id}`, { method: 'DELETE' });
        loadLessons();
      } catch (err) {
        alert('–û—à–∏–±–∫–∞: ' + err.message);
      }
    }
    //** –ó–∞–≥—Ä—É–∑–∫–∞ –¥–Ω—è
    async function loadScheduleByDay() {
      const date = document.getElementById('dayEditorDate').value;
      const groupId = document.getElementById('scheduleGroup').value;

      if (!date || !groupId) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏ –≥—Ä—É–ø–ø—É');
        return;
      }

      const data = await apiRequest(
        `/api/schedule/day?date=${date}&groupId=${groupId}`
      );

      currentLessons = data.lessons || [];

      renderTimeGrid();
    }




    /**
     * –ö–æ–ø–∏—Ä—É–µ—Ç –∑–∞–Ω—è—Ç–∏—è —Å –æ–¥–Ω–æ–π –Ω–µ–¥–µ–ª–∏ –Ω–∞ –¥—Ä—É–≥—É—é
     */
    async function copyWeek() {
      const groupId = document.getElementById('copyGroup').value;
      const from = Number(document.getElementById('fromWeek').value);
      const to = Number(document.getElementById('toWeek').value);

      if (!groupId || from === to) return alert('–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É –∏ —Ä–∞–∑–Ω—ã–µ –Ω–µ–¥–µ–ª–∏');

      if (!confirm(`–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∑–∞–Ω—è—Ç–∏—è –≥—Ä—É–ø–ø—ã —Å –Ω–µ–¥–µ–ª–∏ ${from} –Ω–∞ ${to}? –¶–µ–ª–µ–≤–∞—è –Ω–µ–¥–µ–ª—è –±—É–¥–µ—Ç –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–Ω–∞.`)) return;

      try {
        await apiRequest('/api/admin/lessons/copy-week', {
          method: 'POST',
          body: JSON.stringify({ group_id: groupId, from_week: from, to_week: to })
        });
        alert('–ù–µ–¥–µ–ª—è —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!');
        loadLessons();
      } catch (err) {
        alert('–û—à–∏–±–∫–∞: ' + err.message);
      }
    }

    /**
     * –û—á–∏—â–∞–µ—Ç –≤—Å–µ –∑–∞–Ω—è—Ç–∏—è –≥—Ä—É–ø–ø—ã –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –Ω–µ–¥–µ–ª–µ
     */
    async function clearWeek() {
      const groupId = document.getElementById('clearGroup').value;
      const weekStr = document.getElementById('clearWeek').value;

      if (!groupId || !weekStr) return alert('–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É –∏ –Ω–µ–¥–µ–ª—é');

      const week = Number(weekStr);

      if (!confirm('–£–¥–∞–ª–∏—Ç—å –í–°–ï –∑–∞–Ω—è—Ç–∏—è —ç—Ç–æ–π –Ω–µ–¥–µ–ª–∏? –≠—Ç–æ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!')) return;

      try {
        await apiRequest('/api/admin/lessons/clear-week', {
          method: 'DELETE',
          body: JSON.stringify({ group_id: Number(groupId), week: week })
        });
        alert('–ù–µ–¥–µ–ª—è –æ—á–∏—â–µ–Ω–∞!');
        loadLessons();
      } catch (err) {
        alert('–û—à–∏–±–∫–∞: ' + err.message);
      }
    }

    /**
     * –ó–∞–º–µ–Ω—è–µ—Ç –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è –≤–æ –≤—Å–µ—Ö –∑–∞–Ω—è—Ç–∏—è—Ö –≥—Ä—É–ø–ø—ã
     */
    async function replaceTeacher() {
      const groupId = document.getElementById('replaceGroup').value;
      const oldT = document.getElementById('oldTeacher').value.trim();
      const newT = document.getElementById('newTeacher').value.trim();

      if (!groupId || !oldT || !newT) return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');

      if (!confirm(`–ó–∞–º–µ–Ω–∏—Ç—å "${oldT}" –Ω–∞ "${newT}" –≤–æ –≤—Å–µ—Ö –∑–∞–Ω—è—Ç–∏—è—Ö –≥—Ä—É–ø–ø—ã?`)) return;

      try {
        await apiRequest('/api/admin/lessons/replace-teacher', {
          method: 'PATCH',
          body: JSON.stringify({ group_id: groupId, old_teacher: oldT, new_teacher: newT })
        });
        alert('–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å –∑–∞–º–µ–Ω—ë–Ω!');
        loadLessons();
      } catch (err) {
        alert('–û—à–∏–±–∫–∞: ' + err.message);
      }
    }

    /**
     * –ó–∞–ø–æ–ª–Ω—è–µ—Ç —Å–µ–ª–µ–∫—Ç—ã –º–∞—Å—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π —Å–ø–∏—Å–∫–æ–º –≥—Ä—É–ø–ø
     */
    function populateBulkSelects() {
      const selects = ['copyGroup', 'clearGroup', 'replaceGroup'];

      selects.forEach(selectId => {
        const select = document.getElementById(selectId);
        if (!select) return;

        select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É</option>';

        currentGroups.forEach(g => {
          const opt = document.createElement('option');
          opt.value = g.id;
          opt.textContent = g.name;
          select.appendChild(opt);
        });
      });
    }

    /**
     * –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –∏–∑–º–µ–Ω–µ–Ω–∏–π (–∞—É–¥–∏—Ç-–ª–æ–≥)
     */
    async function loadChangeHistory() {
      try {
        const history = await apiRequest('/api/admin/audit');
        const tbody = document.querySelector('#historyTable tbody');
        tbody.innerHTML = '';

        history.forEach(h => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
          <td>${new Date(h.changed_at).toLocaleString('ru')}</td>
          <td>${h.admin_email}</td>
          <td>${h.action_type}</td>
          <td>${h.description}</td>
        `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏: ' + err.message);
      }
    }


    function removeLesson(index) {
      currentLessons.splice(index, 1);
      renderTimeGrid();
    }
    async function saveScheduleByDay() {
      const date = document.getElementById('dayEditorDate').value;
      const groupId = document.getElementById('scheduleGroup').value;

      await apiRequest('/api/schedule/day', {
        method: 'PUT',
        body: JSON.stringify({
          date,
          groupId,
          lessons: currentLessons
        })
      });

      alert('–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
    }
    async function loadDayGrid() {
      const date = document.getElementById('scheduleDate').value;
      const groupId = document.getElementById('scheduleGroup').value;

      if (!date || !groupId) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏ –≥—Ä—É–ø–ø—É');
        return;
      }

      const data = await apiRequest(
        `/api/schedule/day?date=${date}&groupId=${groupId}`
      );

      currentLessons = data.lessons || [];

      document.getElementById('dayGridSection').style.display = 'block';
      document.getElementById('dayTitle').textContent =
        `–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ ${date}`;

      renderTimeGrid();
    }
    function timeToMinutes(time) {
      const [h, m] = time.split(':').map(Number);
      return h * 60 + m;
    }
    function overlaps(a, b) {
      return (
        timeToMinutes(a.start_time) < timeToMinutes(b.end_time) &&
        timeToMinutes(b.start_time) < timeToMinutes(a.end_time)

      );
    }
    function buildOverlapGroups(lessons) {
      const groups = [];

      lessons.forEach(lesson => {
        let placed = false;

        for (const group of groups) {
          if (group.some(l => overlaps(l, lesson))) {
            group.push(lesson);
            placed = true;
            break;
          }
        }

        if (!placed) {
          groups.push([lesson]);
        }
      });

      return groups;
    }

    function assignColumns(group) {
      const columns = [];

      group.forEach(lesson => {
        let col = 0;

        while (
          columns[col]?.some(l => overlaps(l, lesson))
        ) {
          col++;
        }

        if (!columns[col]) columns[col] = [];
        columns[col].push(lesson);

        lesson._col = col;
        lesson._cols = columns.length;
      });
    }

    function renderTimeGrid() {
      const grid = document.getElementById('dayGrid');
      if (!grid) return;

      grid.innerHTML = '';

      const startDay = 8 * 60;
      const endDay = 20 * 60;
      const pxPerMinute = 1;

      // –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ª–∏–Ω–∏–∏
      for (let t = startDay; t <= endDay; t += 60) {
        const slot = document.createElement('div');
        slot.className = 'time-slot';
        slot.style.top = `${t - startDay}px`;
        slot.textContent = `${String(t / 60).padStart(2, '0')}:00`;
        grid.appendChild(slot);
      }

      // üî• –ù–û–í–û–ï: –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–π
      const groups = buildOverlapGroups([...currentLessons]);

      groups.forEach(group => {
        assignColumns(group);

        group.forEach(lesson => {
          const top =
            timeToMinutes(lesson.start_time) - startDay;
          const height =
            timeToMinutes(lesson.end_time) -
            timeToMinutes(lesson.start_time);

          const widthPercent = 100 / lesson._cols;
          const leftPercent = lesson._col * widthPercent;

          const teacherName = lesson.teacher_id
            ? teachersMap[lesson.teacher_id] || '‚Äî'
            : '‚Äî';

          const block = document.createElement('div');
          block.className = 'lesson-block';
          block.style.top = `${top}px`;
          block.style.height = `${height}px`;
          block.style.left = `${leftPercent}%`;
          block.style.width = `${widthPercent}%`;

          block.innerHTML = `
  <div class="lesson-time">
    ${lesson.start_time} ‚Äì ${lesson.end_time}
  </div>

  <div class="lesson-subject">
    ${lesson.subject}
  </div>

  <div class="lesson-meta">
    <span>üë®‚Äçüè´ ${teacherName}</span><br>
    <span>üè´ –∞—É–¥. ${lesson.room}</span><br>
    <span>üìò ${lesson.type}</span>
  </div>

  <button class="lesson-remove"
    onclick="removeLesson(${currentLessons.indexOf(lesson)})">
    ‚úï
  </button>
`;






          grid.appendChild(block);
        });
      });
    }
    async function loadAudit() {
      const logs = await apiRequest('/api/admin/audit');

      const box = document.getElementById('auditLog');
      box.innerHTML = '';

      logs.forEach(log => {
        const div = document.createElement('div');
        div.className = 'audit-item';

        div.innerHTML = `
      <b>${log.changed_at}</b><br>
      üë§ ${log.admin_email}<br>
      ‚öôÔ∏è ${log.action_type}<br>
      üéØ ${log.target_type} ${log.target_id ?? ''}
      <hr>
    `;

        box.appendChild(div);
      });
    }










    // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï –°–¢–†–ê–ù–ò–¶–´ ===
    loadChangeHistory();
    loadGroups();
    loadLessons();
    loadTeachers();

  </script>
</body>

</html>